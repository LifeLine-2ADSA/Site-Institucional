<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LifeLine | Dashboard</title>
    <link rel="stylesheet" href="./home/css/dashboard.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://kit.fontawesome.com/f0ba5f04ed.js" crossorigin="anonymous"></script>
</head>

<body onload="listarMaquinas(), obterDados()">
    <div class="body-dash">
        <div class="side-bar">
            <img id="img-logo" src="./home/assets/images/logoLifeLine.png" alt="">
            <div class="botoes-sidebar">
                <select class="botao-sidebar" name="maquinas_select" id="maquinas_select" onchange="mudarDash()"></select>
                </select>

                <a class="botao-sidebar">HOME</a>
                <a class="botao-sidebar" href="cadastroMaquina/cadastroMaquina.html">CADASTRAR MAQUINA</a>
                <a class="botao-sidebar">BASE DE CONHECIMENTO</a>


            </div>

        </div>
        <div class="container-dash">
            <div class="navbar">
                <i class="fa-solid fa-right-from-bracket fa-2xl" style="color: #0d0d0d;"></i>
                <i class="fa-sharp fa-solid fa-circle-user fa-2xl" style="color: #000000;"></i>

            </div>
            <div class="container-kpis">
                <div id="primeira_kpi" class="boxKpi kpiIndicador"></div>
                <div id="segunda_kpi" class="boxKpi kpiIndicador">Sua máquina teve 7 alertas durante a semana</div>
                <div id="terceira_kpi" class="boxKpi kpiFrase">A temperatura da sua máquina está em 27ºC isso pode
                    causar o desligamento o da maquina </div>
                <div id="quarta_kpi" class="boxKpi kpiFrase"></div>
            </div>
            <div class="container-graficos">
                <div class="box-graficos">
                    <div class="grafico">
                        <h2>Consumo CPU</h2>
                        <canvas id="myChart"></canvas>
                    </div>
                    <div class="grafico">
                        <h2>Consumo RAM</h2>
                        <canvas id="myChart3"></canvas>
                    </div>
                </div>
                <br><br>
                <div class="box-graficos">
                    <div class="grafico">
                        <h2>Consumo Disco</h2>
                        <canvas id="myChart2"></canvas>
                    </div>
                    <div class="grafico">
                        <h2>Temperatura</h2>
                        <canvas id="myChart4"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>

</html>
<script>
    const idMaquina = sessionStorage.ID_MAQUINA_DASH;

    function mudarDash() {
        const id = maquinas.value;

        sessionStorage.ID_MAQUINA = id;
        location.reload();
    }

    // SELECT COM O NOME DAS MAQUINAS
    function listarMaquinas() {
        fetch(`/maquina/listarMaquinas/${sessionStorage.ID_USUARIO}`, {
        method: "GET",
    })
            .then(function (resposta) {
                resposta.json().then((maquinas) => {
                    maquinas.forEach((maquina) => {
                        maquinas_select.innerHTML += `<option value='${maquina.idMaquina}'>${maquina.nomeMaquina}</option>`;
                    });  
                });
                console.log(resposta)
            })
            .catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
            });
        
    }

    // KPIS
    function obterDados() {
        fetch(`/medidas/ultimas/${idMaquina}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {

                    var data = resposta[resposta.length - 1].dataHora; // data e hora do mysql

                    const date = new Date(data); // formatando a var data
                    const dia = String(date.getUTCDate()).padStart(2, '0');
                    const mes = String(date.getUTCMonth() + 1).padStart(2, '0');
                    const ano = date.getUTCFullYear();
                    const dataFormatada = `${dia}/${mes}/${ano}`;

                    primeira_kpi.innerHTML = `Em ${dataFormatada} sua máquina excedeu o limite de CPU`
                    segunda_kpi.innerHTML = `Sua máquina teve ${resposta.length} alertas durante a semana`
                    terceira_kpi.innerHTML = `A temperatura da sua máquina está em ${resposta[resposta.length - 1].temperatura}ºC isso pode causar o desligamento o da maquina`
                    quarta_kpi.innerHTML = `Atualmente a janela '${resposta[resposta.length - 1].nomeJanela}' é a mais prejudicial ao desempenho de sua maquina`


//                     resposta.json.then((registros) => {
//                         registros.forEach((registro) => {
//                         })
//                     })
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });


        // DASH'S
        const ctx = document.getElementById('myChart');
        const ctx2 = document.getElementById('myChart2');
        const ctx3 = document.getElementById('myChart3');
        const ctx4 = document.getElementById('myChart4');

        new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['Red', 'Blue', 'Yellow', 'Green', 'Purple', 'Orange'],
                datasets: [{
                    label: '# of Votes',
                    data: [12, 19, 3, 5, 2, 3],
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
        new Chart(ctx2, {
            type: 'doughnut',
            data: {
                labels: ['Livre', 'Usados'],
                datasets: [{
                    data: [12, 19],
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
        new Chart(ctx3, {
            type: 'line',
            data: {
                labels: ['Red', 'Blue', 'Yellow', 'Green', 'Purple', 'Orange'],
                datasets: [{
                    label: '# of Votes',
                    data: [12, 19, 3, 5, 2, 3],
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
        new Chart(ctx4, {
            type: 'bar',
            data: {
                labels: ['Google Chrome', 'Spotify', 'Microsoft Teams', 'Microsoft Excel'],
                datasets: [{
                    label: '',
                    data: [12, 19, 3, 5],
                    borderWidth: 1
                }]
            },
            options: {
                indexAxis: 'y',
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        console.log('iniciando plotagem dos gráficos...');

        // Criando estrutura para plotar gráfico - labels
        let labels = [];

        // Criando estrutura para plotar gráfico - dados
        let dados = {
            labels: labels,
            datasets: [{
                label: 'Umidade',
                data: [],
                fill: false,
                borderColor: 'rgb(75, 192, 192)',
                tension: 0.1
            },
            {
                label: 'Temperatura',
                data: [],
                fill: false,
                borderColor: 'rgb(199, 52, 52)',
                tension: 0.1
            }]
        };

        console.log('----------------------------------------------')
        console.log('Estes dados foram recebidos pela funcao "obterDadosGrafico" e passados para "plotarGrafico":')
        console.log(resposta)

        // Inserindo valores recebidos em estrutura para plotar o gráfico
        for (i = 0; i < resposta.length; i++) {
            var registro = resposta[i];
            labels.push(registro.momento_grafico);
            dados.datasets[0].data.push(registro.umidade);
            dados.datasets[1].data.push(registro.temperatura);
        }
        // Criando estrutura para plotar gráfico - config
        const config = {
            type: 'line',
            data: dados,
        };

        // Adicionando gráfico criado em div na tela
        let myChart = new Chart(
            document.getElementById(``),
            config
        );

        setTimeout(() => atualizarGrafico(idMaquina, dados, myChart), 2000);
    }


    // Esta função *atualizarGrafico* atualiza o gráfico que foi renderizado na página,
    // buscando a última medida inserida em tabela contendo as capturas, 

    //     Se quiser alterar a busca, ajuste as regras de negócio em src/controllers
    //     Para ajustar o "select", ajuste o comando sql em src/models
    function atualizarGrafico(idMaquina, dados, myChart) {
        fetch(`/medidas/tempo-real/${idMaquina}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (novoRegistro) {

                    // obterdados(idAquario);
                    // alertar(novoRegistro, idAquario);
                    console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
                    console.log(`Dados atuais do gráfico:`);
                    console.log(dados);

                    if (novoRegistro[0].dataHorario == dados.labels[dados.labels.length - 1]) {
                        console.log("---------------------------------------------------------------")
                        console.log("Como não há dados novos para captura, o gráfico não atualizará.")
                        console.log("Horário do novo dado capturado:")
                        console.log(novoRegistro[0].dataHorario)
                        console.log("Horário do último dado capturado:")
                        console.log(dados.labels[dados.labels.length - 1])
                        console.log("---------------------------------------------------------------")
                    } else {
                        // tirando e colocando valores no gráfico
                        dados.labels.shift(); // apagar o primeiro
                        dados.labels.push(novoRegistro[0].dataHorario); // incluir um novo momento

                        dados.datasets[0].data.shift();  // apagar o primeiro de umidade
                        dados.datasets[0].data.push(novoRegistro[0].consumoCpu); // incluir uma nova medida de umidade

                        dados.datasets[1].data.shift();  // apagar o primeiro de temperatura
                        dados.datasets[1].data.push(novoRegistro[0].temperatura); // incluir uma nova medida de temperatura

                        myChart.update();
                    }
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });

    }
</script>